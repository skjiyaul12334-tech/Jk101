<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Contact Us</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root { --dark-bg: #0f1923; --panel-bg: #213743; --green: #28a745; --red: #e74c3c; --orange: #ff8c00; --yellow: #ffc107; --text-light: #c1d5e0; --text-white: #ffffff; --teal-glow: #00b8a9; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-light); display: flex; justify-content: center; align-items: center; padding: 5px; }
        .page-container { width: 100%; max-width: 420px; height: 100%; max-height: 900px; background-color: var(--dark-bg); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--panel-bg); }
        
        .page-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: var(--panel-bg); flex-shrink: 0; }
        .page-header .header-left { display: flex; align-items: center; }
        .page-header .back-btn { font-size: 24px; cursor: pointer; margin-right: 15px; font-weight: bold; color: var(--text-light); text-decoration: none; }
        .page-header .title { font-size: 18px; font-weight: 700; color: var(--text-white); }
        
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 10px; }
        
        #chat-board { flex-grow: 1; overflow-y: auto; padding: 10px 0; display: flex; flex-direction: column; gap: 12px; }
        #chat-board::-webkit-scrollbar { width: 4px; }
        #chat-board::-webkit-scrollbar-thumb { background-color: var(--teal-glow); border-radius: 4px; }
        
        .chat-message-wrapper { display: flex; max-width: 90%; }
        .chat-message-wrapper.user { align-self: flex-end; }
        .chat-message-wrapper.admin { align-self: flex-start; }
        
        .chat-message { max-width: 100%; padding: 10px 15px; border-radius: 18px; }
        .chat-message.user { background-color: var(--teal-glow); color: var(--text-white); border-bottom-right-radius: 4px; }
        .chat-message.admin { background-color: var(--panel-bg); border-bottom-left-radius: 4px; }
        
        .message-content { font-size: 15px; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap; }
        .message-content img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
        .message-timestamp { font-size: 10px; color: var(--text-light); text-align: right; margin-top: 5px; opacity: 0.7; }
        .chat-message.user .message-timestamp { color: rgba(255,255,255,0.7); }
        
        .bot-options-container { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .bot-option-btn { background-color: #3a506b; border: 1px solid var(--teal-glow); color: var(--text-light); padding: 10px; border-radius: 8px; cursor: pointer; text-align: left; font-size: 14px; transition: background-color 0.2s; }
        .bot-option-btn:hover { background-color: #4b6988; }
        .bot-option-btn:disabled { background-color: #2c3e50; color: #7f8c8d; cursor: not-allowed; border-color: #2c3e50; }
        
        .chat-input-area { flex-shrink: 0; display: flex; align-items: center; gap: 10px; padding: 15px 5px 5px 5px; border-top: 1px solid var(--panel-bg); }
        #chat-file-label, #chat-send-btn { background: none; border: none; color: var(--text-light); font-size: 24px; cursor: pointer; padding: 5px; transition: color 0.2s; }
        #chat-file-label:hover, #chat-send-btn:hover { color: var(--teal-glow); }
        #chat-file-input { display: none; }
        
        #chat-text-input { flex-grow: 1; background-color: var(--panel-bg); border: 1px solid #3a506b; border-radius: 20px; padding: 10px 15px; color: var(--text-white); font-size: 15px; resize: none; max-height: 100px; }
        #chat-text-input:focus { outline: none; border-color: var(--teal-glow); }

        .upload-progress-container { position: relative; width: 24px; height: 24px; display: none; margin-left: auto; margin-right: 15px; }
        .upload-progress-spinner { width: 100%; height: 100%; border: 3px solid rgba(0, 184, 169, 0.3); border-top-color: var(--teal-glow); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .no-chat-msg { text-align: center; color: var(--text-light); padding-top: 50px; font-size: 16px; }
    </style>
</head>
<body>

    <div class="page-container">
        <header class="page-header">
            <div class="header-left">
                <a href="profile.html" class="back-btn">‚Üê</a>
                <span class="title">Contact Us</span>
            </div>
        </header>
        
        <main class="main-content">
            <div id="chat-board">
                <p class="no-chat-msg">Loading chat...</p>
            </div>
            <div class="chat-input-area">
                <input type="file" id="chat-file-input" accept="image/*">
                <label for="chat-file-input" id="chat-file-label" title="Send Image">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M220-160q-24 0-42-18t-18-42v-480q0-24 18-42t42-18h520q24 0 42 18t18 42v480q0 24-18 42t-42-18H220Zm0-60h520v-480H220v480Zm50.64-88.36L420-485.31l148.77 186.36H660l-182.69-231.23L350-322.69l-80-100h-99.36v274.33ZM220-220v-480 480Z"/></svg>
                </label>
                <textarea id="chat-text-input" placeholder="Type a message..." rows="1"></textarea>
                <button id="chat-send-btn" title="Send">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M120-160v-640l760 320-760 320Z"/></svg>
                </button>
                <div class="upload-progress-container" id="upload-progress-container">
                    <div class="upload-progress-spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAc78M_nj7kJtnRCTqdEdWsiMQeq4oSuDc",
            authDomain: "spin-199a1.firebaseapp.com",
            databaseURL: "https://spin-199a1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spin-199a1",
            storageBucket: "spin-199a1.appspot.com",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        let loggedInUserKey = null;
        let botConfig = {};
        let keywordConfig = {};
        let imageReplyConfig = "";
        let isBotConfigLoaded = false;

        const chatBoardEl = document.getElementById('chat-board');
        const chatTextInputEl = document.getElementById('chat-text-input');
        const chatSendBtnEl = document.getElementById('chat-send-btn');
        const chatFileInputEl = document.getElementById('chat-file-input');
        const uploadProgressEl = document.getElementById('upload-progress-container');

        function init() {
            checkLoginStatus();
            setupBotListeners();
            chatSendBtnEl.addEventListener('click', handleSendMessage);
            chatFileInputEl.addEventListener('change', handleFileUpload);
            chatTextInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            chatTextInputEl.addEventListener('input', () => {
                chatTextInputEl.style.height = 'auto';
                chatTextInputEl.style.height = (chatTextInputEl.scrollHeight) + 'px';
            });
            chatBoardEl.addEventListener('click', handleBotOptionClick);
        }

        function setupBotListeners() {
            database.ref('chats/Autoreply').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    botConfig = snapshot.val();
                    isBotConfigLoaded = true;
                }
            });
            database.ref('chats/Information').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    keywordConfig = snapshot.val();
                }
            });
            database.ref('chats/image_received/message').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    imageReplyConfig = snapshot.val();
                }
            });
        }

        function checkLoginStatus() {
            loggedInUserKey = sessionStorage.getItem('loggedInUserKey');
            if (loggedInUserKey) {
                fetchChatHistory(loggedInUserKey);
            } else {
                window.location.href = 'login.html';
            }
        }
        
        function fetchChatHistory(userKey) {
            const chatRef = database.ref('chats/' + userKey);
            chatRef.on('value', (snapshot) => {
                renderChat(snapshot.val());
            });
        }
        
        function renderChat(messagesData) {
            chatBoardEl.innerHTML = '';
            if (!messagesData) {
                const checkConfig = setInterval(() => {
                    if (isBotConfigLoaded) {
                        clearInterval(checkConfig);
                        sendBotMessage('start');
                    }
                }, 100);
                return;
            }

            const messagesArray = Object.values(messagesData);
            messagesArray.sort((a, b) => a.timestamp - b.timestamp);
            
            messagesArray.forEach(msg => {
                const wrapper = document.createElement('div');
                wrapper.className = `chat-message-wrapper ${msg.sender}`;
                
                const bubble = document.createElement('div');
                bubble.className = `chat-message ${msg.sender}`;
                
                let contentHtml = '';
                if (msg.text) {
                    contentHtml = `<div class="message-content">${msg.text}</div>`;
                } else if (msg.imageUrl) {
                    contentHtml = `<div class="message-content"><img src="${msg.imageUrl}" alt="Uploaded image"></div>`;
                } else if (msg.optionsKey && botConfig.start) {
                    const botResponse = botConfig[msg.optionsKey];
                    let optionsHtml = `<div class="message-content">${botResponse.question}</div><div class="bot-options-container">`;
                    for (const key in botResponse.options) {
                        optionsHtml += `<button class="bot-option-btn" data-reply-key="${key}">${botResponse.options[key]}</button>`;
                    }
                    optionsHtml += `</div>`;
                    contentHtml = optionsHtml;
                }
                
                const time = new Date(msg.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                bubble.innerHTML = `${contentHtml}<div class="message-timestamp">${time}</div>`;
                
                wrapper.appendChild(bubble);
                chatBoardEl.appendChild(wrapper);
            });
            
            chatBoardEl.scrollTop = chatBoardEl.scrollHeight;
        }

        function handleSendMessage() {
            const text = chatTextInputEl.value.trim();
            if (!text || !loggedInUserKey) return;

            const messageData = {
                sender: 'user',
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref('chats/' + loggedInUserKey).push(messageData)
                .then(() => {
                    checkForKeywordsAndReply(text);
                });
            
            chatTextInputEl.value = '';
            chatTextInputEl.style.height = 'auto';
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !loggedInUserKey || !file.type.startsWith('image/')) return;

            toggleSendControls(false);
            const storageRef = storage.ref(`chat_uploads/${loggedInUserKey}/${Date.now()}_${file.name}`);
            const uploadTask = storageRef.put(file);

            uploadTask.then(snapshot => snapshot.ref.getDownloadURL())
                .then(downloadURL => {
                    const messageData = {
                        sender: 'user',
                        imageUrl: downloadURL,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    return database.ref('chats/' + loggedInUserKey).push(messageData);
                })
                .then(() => {
                    setTimeout(() => sendBotMessage('image_received'), 500);
                })
                .catch(error => {
                    console.error("Upload failed:", error);
                    alert("Image upload failed.");
                })
                .finally(() => {
                    toggleSendControls(true);
                    chatFileInputEl.value = '';
                });
        }
        
        function toggleSendControls(enable) {
            chatSendBtnEl.style.display = enable ? 'block' : 'none';
            document.getElementById('chat-file-label').style.display = enable ? 'block' : 'none';
            uploadProgressEl.style.display = enable ? 'none' : 'block';
        }

        function sendBotMessage(replyKey) {
            if (!loggedInUserKey || !isBotConfigLoaded) return;

            let messageData = {
                sender: 'admin',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            if (replyKey === 'start' && botConfig.start) {
                messageData.optionsKey = 'start';
            } else if (botConfig.replies && botConfig.replies[replyKey]) {
                const replyData = botConfig.replies[replyKey];
                if (replyData.type === 'single') {
                    messageData.text = replyData.message;
                } else if (replyData.type === 'multiple' && replyData.messages) {
                    messageData.text = replyData.messages[Math.floor(Math.random() * replyData.messages.length)];
                }
            } else if (replyKey === 'image_received' && imageReplyConfig) {
                 messageData.text = imageReplyConfig;
            } else {
                return;
            }
            
            database.ref('chats/' + loggedInUserKey).push(messageData);
        }

        function handleBotOptionClick(event) {
            const target = event.target;
            if (target.classList.contains('bot-option-btn') && !target.disabled) {
                const parentContainer = target.closest('.bot-options-container');
                parentContainer.querySelectorAll('.bot-option-btn').forEach(btn => btn.disabled = true);

                const replyKey = target.dataset.replyKey;
                
                const userChoiceMessage = {
                    sender: 'user',
                    text: target.textContent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref('chats/' + loggedInUserKey).push(userChoiceMessage)
                    .then(() => {
                        setTimeout(() => sendBotMessage(replyKey), 500);
                    });
            }
        }

        function checkForKeywordsAndReply(userText) {
            const lowerCaseText = userText.toLowerCase();
            let replyKey = null;

            for (const keyword in keywordConfig) {
                if (lowerCaseText.includes(keyword)) {
                    replyKey = keywordConfig[keyword];
                    break; 
                }
            }

            if (replyKey) {
                setTimeout(() => sendBotMessage(replyKey), 700);
            }
        }
        
        window.onload = init;
    </script>
</body>
</html>