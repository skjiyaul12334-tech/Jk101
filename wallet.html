<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Withdraw Money</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root { --dark-bg: #0f1923; --panel-bg: #213743; --green: #28a745; --red: #e74c3c; --orange: #ff8c00; --yellow: #ffc107; --text-light: #c1d5e0; --text-white: #ffffff; --teal-glow: #00b8a9; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-light); display: flex; justify-content: center; align-items: center; padding: 5px; }
        .page-container { width: 100%; max-width: 420px; height: 100%; max-height: 900px; background-color: var(--dark-bg); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--panel-bg); }
        
        /* --- Header Styles --- */
        .page-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: var(--panel-bg); flex-shrink: 0; }
        .page-header .header-left { display: flex; align-items: center; }
        .page-header .back-btn { font-size: 24px; cursor: pointer; margin-right: 15px; font-weight: bold; color: var(--text-light); text-decoration: none; }
        .page-header .title { font-size: 18px; font-weight: 700; color: var(--text-white); }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .header-btn { background-color: var(--teal-glow); color: var(--text-white); border: none; border-radius: 5px; padding: 6px 12px; font-size: 12px; font-weight: 500; cursor: pointer; text-decoration: none; }
        
        /* --- Content Styles --- */
        .main-content { padding: 20px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; }
        
        .profile-balance { width: 100%; background-color: var(--panel-bg); border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 25px; }
        .profile-balance p { font-size: 14px; color: var(--text-light); margin-bottom: 5px; }
        .profile-balance h2 { font-size: 28px; font-weight: 700; color: var(--yellow); }

        .form-container { display: flex; flex-direction: column; gap: 15px; }
        .info-text { font-size: 13px; color: var(--yellow); margin-bottom: 10px; text-align: center; line-height: 1.4; }
        .form-group label { display: block; font-size: 14px; margin-bottom: 5px; color: var(--text-light); }
        .form-group input { width: 100%; padding: 12px; background: var(--panel-bg); border: 1px solid #3a506b; border-radius: 8px; color: var(--text-white); font-size: 16px; }
        .form-group input:focus { outline: none; border-color: var(--teal-glow); }
        #withdraw-ifsc { text-transform: uppercase; }

        .submit-btn { width: 100%; padding: 15px; background: var(--green); color: var(--text-white); border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; }
        .submit-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <div class="header-left">
                <!-- This button can take the user back to the profile or home page -->
                <a href="profile.html" class="back-btn">←</a>
                <span class="title">Withdraw Money</span>
            </div>
            <div class="header-right">
                <a href="withdraw-history.html" class="header-btn">History</a>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="profile-balance">
                <p>Available Balance</p>
                <h2 id="balance-display">₹ 0.00</h2>
            </div>

            <div class="form-container">
                <p class="info-text">
                    The minimum withdrawal amount is ₹100. The money will be deposited into your bank account within 24 hours.
                </p>
                <div class="form-group">
                    <label for="withdraw-amount">Amount</label>
                    <input type="number" id="withdraw-amount" placeholder="Enter amount to withdraw">
                </div>
                <div class="form-group">
                    <label for="withdraw-account">Bank Account No.</label>
                    <input type="text" id="withdraw-account" placeholder="Enter Account Number">
                </div>
                <div class="form-group">
                    <label for="withdraw-ifsc">IFSC Code</label>
                    <input type="text" id="withdraw-ifsc" placeholder="Enter IFSC Code">
                </div>
                <button id="submit-withdraw-btn" class="submit-btn">Submit Withdrawal</button>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAc78M_nj7kJtnRCTqdEdWsiMQeq4oSuDc",
            authDomain: "spin-199a1.firebaseapp.com",
            databaseURL: "https://spin-199a1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spin-199a1",
            storageBucket: "spin-199a1.appspot.com",
            messagingSenderId: "201888892362",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let loggedInUserKey = null;
        let currentBalance = 0;

        // UI Elements
        const balanceDisplayEl = document.getElementById('balance-display');
        const amountInputEl = document.getElementById('withdraw-amount');
        const accountInputEl = document.getElementById('withdraw-account');
        const ifscInputEl = document.getElementById('withdraw-ifsc');
        const submitBtnEl = document.getElementById('submit-withdraw-btn');

        // --- INITIALIZATION ---
        function init() {
            checkLoginStatus();
            submitBtnEl.addEventListener('click', handleSubmitWithdrawal);
        }

        // --- AUTH & DATA LOADING ---
        function checkLoginStatus() {
            loggedInUserKey = sessionStorage.getItem('loggedInUserKey');
            if (loggedInUserKey) {
                loadUserData(loggedInUserKey);
            } else {
                // If not logged in, redirect to login page
                window.location.href = 'login.html';
            }
        }
        
        function loadUserData(userKey) {
            const userRef = database.ref('customers/' + userKey);
            // .on() ensures the balance is always up-to-date in real-time
            userRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    currentBalance = parseFloat(userData.balance) || 0;
                    updateBalanceUI();
                } else {
                    alert('User account not found. Logging out.');
                    handleLogout();
                }
            });
        }
        
        function updateBalanceUI() {
            balanceDisplayEl.textContent = `₹ ${currentBalance.toFixed(2)}`;
        }

        function handleLogout() {
            if (loggedInUserKey) {
                database.ref('customers/' + loggedInUserKey).off();
            }
            sessionStorage.removeItem('loggedInUserKey');
            window.location.href = 'login.html';
        }

        // --- WITHDRAWAL LOGIC ---
        async function handleSubmitWithdrawal() {
            if (!loggedInUserKey) {
                alert("Please log in to submit a request.");
                return;
            }

            const amount = parseFloat(amountInputEl.value);
            const bank = accountInputEl.value.trim();
            const ifsc = ifscInputEl.value.trim().toUpperCase();

            // Validation
            if (isNaN(amount) || bank === '' || ifsc === '') { 
                alert("Please fill all fields correctly."); 
                return; 
            }
            if (amount < 100) {
                alert("Minimum withdrawal amount is ₹100.");
                return;
            }
            if (amount > currentBalance) {
                alert("Insufficient balance for this withdrawal.");
                return;
            }

            submitBtnEl.disabled = true;
            submitBtnEl.textContent = 'Submitting...';

            try {
                // Use a transaction to safely deduct the balance from the server
                const balanceRef = database.ref(`customers/${loggedInUserKey}/balance`);
                const transactionResult = await balanceRef.transaction(balance => {
                    if (balance !== null && balance >= amount) {
                        return balance - amount;
                    }
                    // Abort transaction if balance is not enough or doesn't exist
                    return; 
                });

                if (transactionResult.committed) {
                    // If balance was successfully deducted, create the withdrawal record
                    const withdrawalData = {
                        amount: amount,
                        bank: bank,
                        ifsc: ifsc,
                        status: 'pending', // Initial status is 'pending'
                        userId: loggedInUserKey,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await database.ref('withdraw').push(withdrawalData);
                    
                    alert("Withdrawal request submitted successfully!");
                    
                    // Clear form fields after successful submission
                    amountInputEl.value = '';
                    accountInputEl.value = '';
                    ifscInputEl.value = '';
                } else {
                    // This will be triggered if the transaction was aborted by our logic
                    alert("Withdrawal failed. Your balance may have been updated. Please try again.");
                }
            } catch (error) {
                console.error("Error submitting withdrawal request:", error);
                alert("An error occurred during submission. Please contact support.");
            } finally {
                // This block will always run, whether the try succeeded or failed
                submitBtnEl.disabled = false;
                submitBtnEl.textContent = 'Submit Withdrawal';
            }
        }
        
        window.onload = init;
    </script>
</body>
</html>