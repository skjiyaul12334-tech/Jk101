<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Withdraw Money</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    :root { 
        --dark-bg: #4c0000; /* Dark Red */
        --panel-bg: #800000; /* Medium Red */
        --green: #28a745; 
        --red: #e74c3c; 
        --orange: #ff8c00; 
        --yellow: #ffc107; 
        --text-light: #f5c5c5; /* Light Reddish White */
        --text-white: #ffffff; 
        --teal-glow: #ff5252; /* Bright Red for highlights */
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-light); display: flex; justify-content: center; align-items: center; padding: 5px; }
    .page-container { width: 100%; max-width: 420px; height: 100%; max-height: 900px; background-color: var(--dark-bg); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--panel-bg); }
    .page-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: var(--panel-bg); flex-shrink: 0; }
    .page-header .header-left { display: flex; align-items: center; }
    .page-header .back-btn { font-size: 24px; cursor: pointer; margin-right: 15px; font-weight: bold; color: var(--text-light); text-decoration: none; }
    .page-header .title { font-size: 18px; font-weight: 700; color: var(--text-white); }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .header-btn { background-color: var(--teal-glow); color: var(--text-white); border: none; border-radius: 5px; padding: 6px 12px; font-size: 12px; font-weight: 500; cursor: pointer; text-decoration: none; }
    .main-content { padding: 20px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; }
    .profile-balance { width: 100%; background-color: var(--panel-bg); border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 25px; }
    .profile-balance p { font-size: 14px; color: var(--text-light); margin-bottom: 5px; }
    .profile-balance h2 { font-size: 28px; font-weight: 700; color: var(--yellow); }
    .form-container { display: flex; flex-direction: column; gap: 15px; }
    .info-text { font-size: 13px; color: var(--yellow); margin-bottom: 10px; text-align: center; line-height: 1.4; }
    .form-group label { display: block; font-size: 14px; margin-bottom: 5px; color: var(--text-light); }
    .form-group input { width: 100%; padding: 12px; background: var(--panel-bg); border: 1px solid #3a506b; border-radius: 8px; color: var(--text-white); font-size: 16px; }
    .form-group input:focus { outline: none; border-color: var(--teal-glow); }
    .submit-btn { width: 100%; padding: 15px; background: var(--green); color: var(--text-white); border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; }
    .submit-btn:disabled { background-color: #6c757d; cursor: not-allowed; }

    .bank-account-section { display: flex; align-items: center; justify-content: space-between; background: var(--panel-bg); padding: 12px; border-radius: 8px; }
    #account-info .account-number { font-size: 16px; }
    #account-info .view-icon { margin-left: 10px; cursor: pointer; }
    #add-bank-btn { background-color: var(--red); color: var(--text-white); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }

    .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.3s; }
    .dialog-content { background: linear-gradient(135deg, #a52a2a, #8b0000); color: var(--text-white); padding: 25px; border-radius: 12px; border: 2px solid var(--red); width: 90%; max-width: 380px; animation: scaleUp 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .dialog-content h3 { text-align: center; margin-bottom: 20px; }
    .dialog-content .form-group input { background: rgba(0,0,0,0.2); border: 1px solid var(--red); color: white; }
    .dialog-content .form-group input::placeholder { color: rgba(255,255,255,0.7); }
    .dialog-content .submit-btn { background: var(--dark-bg); }
    
    #new-bank-modal .dialog-content { background: var(--red); border-color: var(--yellow); }
    #new-bank-modal .form-group input { border-color: var(--red); }
    #new-bank-modal .submit-btn { background: rgb(44, 62, 80); }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="page-header">
      <div class="header-left">
        <a href="profile.html" class="back-btn">←</a>
        <span class="title">Withdraw Money</span>
      </div>
      <div class="header-right">
        <a href="withdraw-history.html" class="header-btn">History</a>
      </div>
    </header>
    <main class="main-content">
      <div class="profile-balance">
        <p>Available Balance</p>
        <h2 id="balance-display">₹ 0.00</h2>
      </div>
      <div class="form-container">
        <p class="info-text">Minimum withdrawal is ₹100. The amount will be credited within 24 hours.</p>
        <div class="form-group">
          <label for="withdraw-amount">Amount</label>
          <input type="number" id="withdraw-amount" placeholder="Enter amount to withdraw">
        </div>
        
        <div class="bank-account-section">
            <div id="account-info">
                <span id="account-number-display">No bank account added</span>
                <i class="fas fa-eye view-icon" id="view-account-btn" style="display: none;"></i>
            </div>
            <button id="add-bank-btn">Add/Change Bank</button>
        </div>

        <button id="submit-withdraw-btn" class="submit-btn">Withdraw</button>
      </div>
    </main>
  </div>

  <div id="bank-details-modal" class="dialog-overlay">
      <div class="dialog-content">
          <h3>Add Bank Details</h3>
          <div class="form-group"><label for="bank-name">Bank Name</label><input type="text" id="bank-name" placeholder="Enter Bank Name"></div>
          <div class="form-group"><label for="account-number">Bank Account Number</label><input type="text" id="account-number" placeholder="Enter Account Number"></div>
          <div class="form-group"><label for="ifsc-code">IFSC Code</label><input type="text" id="ifsc-code" placeholder="Enter IFSC Code"></div>
          <button id="save-bank-details-btn" class="submit-btn">Save</button>
          <button id="new-bank-btn" class="submit-btn" style="background-color: var(--orange); margin-top: 10px;">New Bank</button>
      </div>
  </div>

  <div id="new-bank-modal" class="dialog-overlay">
      <div class="dialog-content">
          <h3>Add New Bank</h3>
          <div class="form-group"><label for="new-bank-name">Bank Name</label><input type="text" id="new-bank-name" placeholder="Enter Bank Name"></div>
          <div class="form-group"><label for="new-account-number">Bank Account Number</label><input type="text" id="new-account-number" placeholder="Enter Account Number"></div>
          <div class="form-group"><label for="new-ifsc-code">IFSC Code</label><input type="text" id="new-ifsc-code" placeholder="Enter IFSC Code"></div>
          <button id="save-new-bank-btn" class="submit-btn">Save</button>
      </div>
  </div>

  <div id="alert-popup" class="dialog-overlay">
      <div class="dialog-content">
          <h3>Action Required</h3>
          <p>Please add your bank account first.</p>
          <button id="alert-add-bank-btn" class="submit-btn">Add Bank</button>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAc78M_nj7kJtnRCTqdEdWsiMQeq4oSuDc",
      authDomain: "spin-199a1.firebaseapp.com",
      databaseURL: "https://spin-199a1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "spin-199a1",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let loggedInUserKey = null;
    let currentBalance = 0;
    let vipWithdrawLimit = 0;
    let vipLimitCount = 0;
    let bankDetails = null;
    let isAccountVisible = false;

    const balanceDisplayEl = document.getElementById("balance-display");
    const amountInputEl = document.getElementById("withdraw-amount");
    const submitBtnEl = document.getElementById("submit-withdraw-btn");
    const accountNumberDisplay = document.getElementById('account-number-display');
    const viewAccountBtn = document.getElementById('view-account-btn');
    const bankModal = document.getElementById('bank-details-modal');
    const newBankModal = document.getElementById('new-bank-modal');
    const alertPopup = document.getElementById('alert-popup');
    const bankNameInput = document.getElementById('bank-name');
    const accountNumberInput = document.getElementById('account-number');
    const ifscCodeInput = document.getElementById('ifsc-code');

    window.onload = init;
    function init() {
      loggedInUserKey = sessionStorage.getItem("loggedInUserKey");
      if (!loggedInUserKey) return (window.location.href = "login.html");
      loadUserData(loggedInUserKey);
      
      document.getElementById('add-bank-btn').addEventListener('click', openBankModal);
      document.getElementById('save-bank-details-btn').addEventListener('click', saveBankDetails);
      document.getElementById('new-bank-btn').addEventListener('click', () => {
          bankModal.style.display = 'none';
          newBankModal.style.display = 'flex';
      });
      document.getElementById('save-new-bank-btn').addEventListener('click', saveBankDetails);
      viewAccountBtn.addEventListener('click', toggleAccountNumberVisibility);
      submitBtnEl.addEventListener("click", handleWithdraw);
      
      bankModal.addEventListener('click', (e) => { if (e.target === bankModal) bankModal.style.display = 'none'; });
      newBankModal.addEventListener('click', (e) => { if (e.target === newBankModal) newBankModal.style.display = 'none'; });
      alertPopup.addEventListener('click', (e) => { if (e.target === alertPopup) alertPopup.style.display = 'none'; });
      document.getElementById('alert-add-bank-btn').addEventListener('click', () => {
          alertPopup.style.display = 'none';
          openBankModal();
      });
    }

    function loadUserData(userKey) {
      db.ref("customers/" + userKey).on("value", (snap) => {
        if (!snap.exists()) return;
        const user = snap.val();
        currentBalance = parseFloat(user.balance) || 0;
        balanceDisplayEl.textContent = "₹ " + currentBalance.toFixed(2);

        if (user.VIP) {
            vipWithdrawLimit = parseFloat(user.VIP.withdrawLimit) || 0;
            vipLimitCount = parseInt(user.VIP.Limit) || 0;
        }
        
        bankDetails = user.bankDetails || null;
        updateBankDetailsUI();
      });
    }

    function updateBankDetailsUI() {
        if (bankDetails && bankDetails.accountNumber) {
            viewAccountBtn.style.display = 'inline-block';
            toggleAccountNumberVisibility(true);
        } else {
            accountNumberDisplay.textContent = 'No bank account added';
            viewAccountBtn.style.display = 'none';
        }
    }

    function openBankModal() {
        if (bankDetails) {
            bankNameInput.value = bankDetails.Bankname || '';
            accountNumberInput.value = bankDetails.accountNumber || '';
            ifscCodeInput.value = bankDetails.ifscCode || '';
        }
        bankModal.style.display = 'flex';
    }

    function toggleAccountNumberVisibility(forceHide = false) {
        if (forceHide) isAccountVisible = true;
        
        isAccountVisible = !isAccountVisible;
        viewAccountBtn.classList.toggle('fa-eye-slash', isAccountVisible);
        viewAccountBtn.classList.toggle('fa-eye', !isAccountVisible);

        if (isAccountVisible) {
            accountNumberDisplay.textContent = bankDetails.accountNumber;
        } else {
            const accNum = bankDetails.accountNumber;
            accountNumberDisplay.textContent = `${accNum.slice(0, 3)}*****${accNum.slice(-2)}`;
        }
    }

    async function saveBankDetails() {
        const bankName = document.getElementById('new-bank-name').value.trim() || bankNameInput.value.trim();
        const accountNumber = document.getElementById('new-account-number').value.trim() || accountNumberInput.value.trim();
        const ifscCode = document.getElementById('new-ifsc-code').value.trim() || ifscCodeInput.value.trim();

        if (!bankName || !accountNumber || !ifscCode) return alert("Please fill all the fields.");

        const newBankDetails = { Bankname: bankName, accountNumber, ifscCode };
        
        try {
            await db.ref(`customers/${loggedInUserKey}/bankDetails`).set(newBankDetails);
            bankModal.style.display = 'none';
            newBankModal.style.display = 'none';
            alert("Bank details saved successfully!");
        } catch (error) {
            alert("Failed to save details. " + error.message);
        }
    }

    async function handleWithdraw() {
      const amount = parseFloat(amountInputEl.value);
      if (isNaN(amount) || amount < 100) return alert("Minimum withdrawal is ₹100.");
      if (amount > currentBalance) return alert("Insufficient balance.");
      if (!bankDetails) {
          alertPopup.style.display = 'flex';
          return;
      }

      if (vipLimitCount <= 0) return alert("Error: You have reached your daily withdrawal limit.");
      if (vipWithdrawLimit > 0 && amount > vipWithdrawLimit) return alert(`Error: Your maximum withdrawal amount per transaction is ₹${vipWithdrawLimit}`);

      submitBtnEl.disabled = true;
      submitBtnEl.textContent = 'Processing...';

      try {
        const newBalance = currentBalance - amount;
        const newLimitCount = vipLimitCount - 1;

        const updates = {};
        updates[`customers/${loggedInUserKey}/balance`] = newBalance;
        updates[`customers/${loggedInUserKey}/VIP/Limit`] = newLimitCount;

        await db.ref().update(updates);

        await db.ref("withdraw").push({
          amount,
          Bankname: bankDetails.Bankname,
          bank: bankDetails.accountNumber,
          ifsc: bankDetails.ifscCode,
          status: "pending",
          userId: loggedInUserKey,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
        });

        alert("Withdrawal request submitted successfully!");
        amountInputEl.value = "";
      } catch (err) {
        console.error(err);
        alert("Withdrawal failed. Please try again.");
      } finally {
        submitBtnEl.disabled = false;
        submitBtnEl.textContent = 'Withdraw';
      }
    }
  </script>
</body>
</html>