<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horse Racing</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        /* --- CSS Updated with new Purple Theme --- */
        :root { 
            --purple-grad-start: #5e2a5e;
            --purple-grad-end: #2c0b2c;
            --panel-bg: #4a2c4a;
            --panel-border: #6b4b6b;
            --accent-pink: #e91e63; 
            --accent-pink-dark: #c2185b;
            --yellow: #ffc107;
            --text-light: #e1bee7;
            --text-white: #ffffff; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background: radial-gradient(ellipse at center, var(--purple-grad-start), var(--purple-grad-end));
            color: var(--text-light); 
            display: flex; 
            justify-content: center; 
        }

        .game-container { 
            width: 100%; 
            max-width: 420px; 
            height: 100%; 
            max-height: 900px; 
            background-color: transparent; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Header CSS Updated for new structure and theme --- */
        .top-bar { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background-color: var(--panel-bg); }
        .profile-icon img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--accent-pink); display: block; }
        .balance { display: flex; align-items: center; font-weight: 700; font-size: 14px; background-color: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px; }
        .balance .coin { margin-right: 6px; }
        .balance .add-balance-icon { background-color: var(--accent-pink); color: var(--text-white); border-radius: 50%; width: 22px; height: 22px; display: inline-flex; justify-content: center; align-items: center; text-decoration: none; font-weight: 700; margin-left: 8px; font-size: 18px; }
        .top-icons { display: flex; align-items:center; gap: 15px; }
        .top-icons a { color: var(--text-light); text-decoration: none; font-size: 24px; }
        
        /* --- HORSE RACING GAME STYLES --- */
        .page-content { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; padding: 10px; background-color: transparent; }
        .horse-race-container { display: flex; flex-direction: column; height: 100%; gap: 10px; }

        .status-bar { background-color: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; text-align: center; color: var(--yellow); font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .status-bar .timer-box { color: var(--text-light); font-size: 12px;}

        .racetrack-container { flex-grow: 1; border: 2px solid var(--panel-bg); border-radius: 8px; overflow: hidden; position: relative; background-color: #3e203e; background-image: url('https://www.transparenttextures.com/patterns/subtle-stripes.png'); }
        #racetrack {
            position: relative; width: 100%; height: 100%;
            animation: slideTrack 20s linear infinite; animation-play-state: paused;
        }
        @keyframes slideTrack { from { background-position: 200% 0; } to { background-position: 0 0; } }
        
        .horse { position: absolute; right: -50px; width: 45px; height: 45px; transition: all 0.5s ease; display: flex; align-items: center; justify-content: center; }
        .horse svg { width: 100%; height: 100%; transform: scaleX(-1); }
        .horse .horse-number { position: absolute; font-size: 10px; font-weight: bold; color: white; background-color: rgba(0,0,0,0.7); border-radius: 50%; width: 16px; height: 16px; line-height: 16px; text-align: center; top: 0; }

        .horse.running { animation-name: run; animation-timing-function: linear; animation-fill-mode: forwards; }
        @keyframes run { from { transform: translateX(0); } to { transform: translateX(calc(-100vw - 40px)); } }

        .finish-line { position: absolute; left: 20px; top: 0; bottom: 0; width: 4px; background: repeating-linear-gradient(white, white 10px, black 10px, black 20px); }

        .betting-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; flex-shrink: 0; }
        .bet-box { background-color: var(--panel-bg); border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; position: relative; overflow: hidden;}
        .bet-box:hover { background-color: var(--panel-border); }
        .bet-box.winner { animation: winner-glow 1.5s infinite; }
        @keyframes winner-glow {
            0% { box-shadow: 0 0 5px var(--accent-pink), 0 0 10px var(--accent-pink); border-color: var(--accent-pink); }
            50% { box-shadow: 0 0 15px var(--accent-pink), 0 0 30px var(--accent-pink); border-color: var(--text-white); }
            100% { box-shadow: 0 0 5px var(--accent-pink), 0 0 10px var(--accent-pink); border-color: var(--accent-pink); }
        }
        .bet-box .horse-head svg { width: 30px; height: 30px; margin-bottom: 5px; }
        .bet-box .bet-odds { font-size: 14px; font-weight: 700; color: var(--yellow); }
        .bet-box .bet-amount-display { position: absolute; bottom: 2px; right: 4px; background: var(--accent-pink-dark); color: white; font-size: 10px; font-weight: bold; padding: 2px 5px; border-radius: 5px; }

        .chip-selector { display: flex; justify-content: center; align-items: flex-end; gap: 10px; padding: 10px 0; flex-shrink: 0; margin-left: auto; width: 60%; }
        
        .chip { 
            background-color: var(--panel-border); color: white; border: 2px solid white; border-radius: 50%; 
            font-weight: 700; cursor: pointer; transition: all 0.2s ease-out; display: flex; 
            align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            font-size: 12px; width: 38px; height: 38px; 
        }
        .chip:first-child { font-size: 16px; width: 48px; height: 48px; }
        .chip.active { transform: translateY(-10px) scale(1.15); background-color: var(--accent-pink); box-shadow: 0 5px 15px rgba(233, 30, 99, 0.5); }
        
        #winnings-popup { position: fixed; top: 60px; left: 50%; transform: translate(-50%, -200%); background: linear-gradient(to right, var(--accent-pink), var(--accent-pink-dark)); color: var(--text-white); padding: 10px 20px; border-radius: 20px; z-index: 1000; text-align: center; font-weight: bold; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4); transition: transform 0.4s ease-out; pointer-events: none; }
        #winnings-popup.show { transform: translate(-50%, 0); }

    </style>
</head>
<body>

    <div class="game-container">
        <header class="top-bar">
            <a href="profile.html" class="profile-icon"><img id="profile-main-img" src="https://i.pravatar.cc/40?u=guest" alt="P"></a>
            <div class="balance">
                <span class="coin">ðŸ’°</span><span id="balance-amount" class="balance-amount">0.00</span>
                <a href="addmoney.html" class="add-balance-icon">+</a>
            </div>
            <div class="top-icons">
                <a href="notification.html">ðŸ””</a>
                <a href="Menu.html" class="icon-menu">â˜°</a>
            </div>
        </header>
        
        <div class="page-content horse-race-page">
            <div class="horse-race-container">
                <div class="status-bar">
                    <span id="game-status-text">Place your bets!</span>
                    <div class="timer-box">
                        Next Race: <span id="race-timer">10</span>s
                    </div>
                </div>
                <div class="racetrack-container">
                    <div id="racetrack">
                         <!-- Horses are added dynamically by JavaScript -->
                        <div class="finish-line"></div>
                    </div>
                </div>
                <div class="betting-grid" id="betting-grid">
                    <!-- Betting boxes are added dynamically by JavaScript -->
                </div>
                <div class="chip-selector" id="chip-selector">
                    <!-- Chips are added dynamically by JavaScript -->
                </div>
            </div>
        </div>

    </div>
    
    <div id="winnings-popup">You won <span id="winnings-amount"></span>!</div>
    <audio id="race-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1636a05e83.mp3?filename=horse-gallop-6275.mp3" loop></audio>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- SCRIPT FOR HEADER AND AUTHENTICATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAc78M_nj7kJtnRCTqdEdWsiMQeq4oSuDc",
            authDomain: "spin-199a1.firebaseapp.com",
            databaseURL: "https://spin-199a1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "spin-199a1",
            storageBucket: "spin-199a1.appspot.com",
            messagingSenderId: "201888892362",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let balance = 0.00; 
        let loggedInUserKey = null;

        const balanceEl = document.getElementById('balance-amount');
        const profileMainImgEl = document.getElementById('profile-main-img');
        
        function checkLoginStatus() {
            loggedInUserKey = sessionStorage.getItem('loggedInUserKey');
            if (loggedInUserKey) {
                loadUserData(loggedInUserKey);
            } else {
                window.location.href = 'login.html';
            }
        }
        
        function loadUserData(userKey) {
            const userRef = database.ref('customers/' + userKey);
            userRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    balance = userData.balance;
                    updateBalanceUI();
                    if (profileMainImgEl) {
                        profileMainImgEl.src = `https://i.pravatar.cc/40?u=${userKey}`;
                    }
                } else {
                    alert('User account not found. Logging out.');
                    handleLogout();
                }
            });
        }
        
        function handleLogout() {
            sessionStorage.removeItem('loggedInUserKey');
            window.location.href = 'login.html';
        }

        function updateBalanceUI() { 
            const currentBalance = parseFloat(balance) || 0;
            balanceEl.textContent = currentBalance.toFixed(2);
        }

        // --- NEW HORSE RACING GAME SCRIPT ---
        const HORSE_COUNT = 6;
        // Horse colors updated for the new theme
        const HORSE_COLORS = ['#f44336', '#03a9f4', '#8bc34a', '#ffeb3b', '#ff9800', '#9c27b0'];
        const CHIP_AMOUNTS = [10, 50, 100, 500, 1000];
        const PAYOUT_MULTIPLIER = 5;
        const BETTING_TIME = 10;

        const racetrack = document.getElementById('racetrack');
        const bettingGrid = document.getElementById('betting-grid');
        const chipSelector = document.getElementById('chip-selector');
        const statusTextEl = document.getElementById('game-status-text');
        const timerEl = document.getElementById('race-timer');
        const raceSound = document.getElementById('race-sound');

        let gameState = 'finished'; // betting, racing, finished
        let selectedChipAmount = 10;
        let bets = {};
        let countdown;

        const horseSVG = `<svg viewBox="0 0 260 240" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"><path d="M193.513 37.163c-7.32 1.83-12.201 3.66-14.641 5.49-5.49 4.265-5.49 11.59-1.22 16.471 2.441 2.44 6.711 4.265 10.981 4.265 6.091 0 10.371-4.265 10.981-5.49 1.22-1.22 1.22-3.05 1.22-4.265 0-4.88-4.265-8.54-9.15-10.37-1.83-.61-3.66-1.22-5.49-1.22-1.22 0-1.83 0-2.44.61.025.023-.604.286-.61.31zm-28.068 28.068c-1.83 1.83-1.83 4.265-.61 6.711l13.421 21.352c1.22 2.44 3.66 3.66 6.091 3.05 2.441-1.22 3.66-3.66 3.05-6.091l-13.421-21.352c-1.219-2.44-3.66-3.66-6.09-3.05-1.22.61-1.83 1.22-2.441 1.22zM211.705 9.15c-1.22-1.22-2.44-1.83-4.265-1.83-1.831 0-3.66.61-4.881 1.83l-1.83 1.83c-1.22 1.22-1.83 3.05-1.83 4.88 0 1.83.61 3.66 1.83 4.881l1.83 1.83c1.22 1.22 3.05 1.83 4.88 1.83 1.83 0 3.66-.61 4.881-1.83l1.83-1.83c1.22-1.22 1.83-3.05 1.83-4.881 0-1.83-.61-3.66-1.83-4.88l-1.83-1.83zM157.402 69.55c-1.22 1.83-1.22 4.265 0 6.091l15.861 21.352c1.22 1.83 3.66 2.44 5.49 1.83 2.441-1.22 3.66-3.05 2.441-5.49L165.334 71.98c-1.22-1.83-3.66-2.44-5.49-1.83-1.22.61-1.83.61-2.44.6zM82.361 74.43c-1.22-1.22-3.05-1.83-4.88-1.83-1.831 0-3.661.61-4.881 1.83l-10.371 10.371c-1.22 1.22-1.83 3.05-1.83 4.881 0 1.83.61 3.66 1.83 4.88l10.37 10.371c1.22 1.22 3.05 1.83 4.881 1.83 1.83 0 3.66-.61 4.88-1.83l10.371-10.37c1.22-1.22 1.83-3.05 1.83-4.881 0-1.831-.61-3.661-1.83-4.881l-10.37-10.37zM24.403 103.1c-1.83-1.22-4.265-.61-5.49 1.22-1.22 1.83-1.22 4.265.61 5.49l26.848 18.912c1.83 1.22 4.265.61 5.49-1.22 1.22-1.83 1.22-4.265-.61-5.49L24.403 103.1zM237.926 73.21c-46.368-12.81-43.928 20.742-53.079 31.118-9.15 10.371-21.352 10.981-32.338 12.811-13.421 2.441-26.848 0-40.269-3.05-21.352-5.49-35.389-18.912-35.389-18.912s-10.981-10.371-26.238-12.201c-15.251-1.831-29.288 10.37-29.288 10.37S4.883 118.96.613 138.48c-4.27 19.521 17.081 38.439 17.081 38.439s10.371 8.54 26.238 15.25c15.861 6.711 32.338 12.201 47.589 10.981 15.25-1.22 29.288-11.59 29.288-11.59s10.981-10.371 20.132-12.811c9.15-2.44 19.521 1.22 19.521 1.22l-1.83 23.182c0 2.44 1.22 4.88 3.66 5.49 2.44.61 4.88-1.22 5.49-3.66l10.371-46.979c.61-2.44-.61-4.88-3.05-5.49-2.44-.61-4.881.61-5.49 3.05l-5.49 26.238c-2.44 1.22-5.49 1.83-7.931 1.22-4.265-1.22-7.32-4.265-7.93-7.93l1.83-20.132s10.371-4.265 21.962-1.22c11.59 3.05 14.031 14.03 14.031 14.03s1.22 1.83 3.05 1.83h3.05c1.22 0 2.44-1.22 2.44-2.44v-27.458c0-1.83-1.22-3.05-2.44-3.05h-2.44c-1.83 0-3.05 1.22-3.05 3.05v21.352c-4.88-12.2-4.88-26.238 6.09-37.219 10.981-10.981 26.238-12.811 37.219-10.371 2.441.61 4.265 3.05 3.66 5.49-.61 2.44-3.05 4.265-5.49 3.66-8.54-1.83-19.521-.61-27.458 7.32-8.54 8.54-9.15 19.521-5.49 28.678l1.22-1.22c.61-1.22 1.83-1.83 3.05-1.83h1.83c1.83 0 3.05 1.22 3.05 3.05v15.25c0 1.83-1.22 3.05-3.05 3.05h-1.83c-1.22 0-2.44-.61-3.05-1.83-3.66 6.091-8.54 10.981-15.25 14.641l21.352-1.22c1.83 0 3.66-1.22 4.265-2.44 1.22-1.83.61-4.265-1.22-5.49l-14.641-9.15c2.441-2.44 4.881-5.49 6.711-8.54l10.371 6.091c1.831 1.22 4.265.61 5.49-1.22.61-.61 1.22-1.83 1.22-2.44v-13.421c0-1.22-.61-2.44-1.22-3.05z" fill-rule="nonzero"/></svg>`;

        function initHorseGame() {
            if (gameState === 'finished') {
                setupUI();
                resetGame();
            }
        }
        
        function setupUI() {
            chipSelector.innerHTML = '';
            CHIP_AMOUNTS.forEach(amount => {
                const chip = document.createElement('button');
                chip.className = 'chip';
                chip.dataset.amount = amount;
                chip.textContent = amount >= 1000 ? `${amount/1000}k` : amount;
                if (amount === selectedChipAmount) chip.classList.add('active');
                chip.addEventListener('click', () => selectChip(amount));
                chipSelector.appendChild(chip);
            });

            bettingGrid.innerHTML = '';
            racetrack.innerHTML = `<div class="finish-line"></div>`;
            for (let i = 1; i <= HORSE_COUNT; i++) {
                const betBox = document.createElement('div');
                betBox.className = 'bet-box';
                betBox.dataset.horse = i;
                betBox.innerHTML = `<div class="horse-head">${horseSVG}</div><div class="bet-odds">${PAYOUT_MULTIPLIER}x</div>`;
                betBox.querySelector('svg').style.fill = HORSE_COLORS[i-1];
                betBox.addEventListener('click', () => placeBet(i));
                bettingGrid.appendChild(betBox);

                const horse = document.createElement('div');
                horse.className = 'horse';
                horse.id = `horse-${i}`;
                horse.style.top = `${(i - 1) * (100 / HORSE_COUNT)}%`;
                horse.innerHTML = `<div class="horse-number">${i}</div>${horseSVG}`;
                horse.querySelector('svg').style.fill = HORSE_COLORS[i-1];
                racetrack.appendChild(horse);
            }
        }

        function selectChip(amount) {
            selectedChipAmount = amount;
            document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', c.dataset.amount == amount));
        }

        function placeBet(horseNumber) {
            if (gameState !== 'betting') return;
            if (balance < selectedChipAmount) { alert("Insufficient balance!"); return; }

            database.ref('customers/' + loggedInUserKey + '/balance').set(firebase.database.ServerValue.increment(-selectedChipAmount));
            bets[horseNumber] = (bets[horseNumber] || 0) + selectedChipAmount;
            
            const betBox = document.querySelector(`.bet-box[data-horse='${horseNumber}']`);
            let amountDisplay = betBox.querySelector('.bet-amount-display');
            if (!amountDisplay) {
                amountDisplay = document.createElement('div');
                amountDisplay.className = 'bet-amount-display';
                betBox.appendChild(amountDisplay);
            }
            amountDisplay.textContent = `â‚¹${bets[horseNumber]}`;
        }
        
        function resetGame() {
            gameState = 'betting';
            bets = {};
            racetrack.style.animationPlayState = 'paused';
            if(raceSound) { raceSound.pause(); raceSound.currentTime = 0; }
            document.querySelectorAll('.bet-box').forEach(box => {
                box.classList.remove('winner');
                const amountDisplay = box.querySelector('.bet-amount-display');
                if (amountDisplay) amountDisplay.remove();
            });
            document.querySelectorAll('.horse').forEach((horse) => {
                horse.classList.remove('running');
                horse.style.animation = 'none';
                horse.style.transform = 'translateX(0)';
            });
            statusTextEl.textContent = 'Place your bets!';
            startBettingTimer();
        }

        function startBettingTimer() {
            let timer = BETTING_TIME;
            timerEl.textContent = timer;
            document.querySelector('.timer-box').style.visibility = 'visible';
            clearInterval(countdown);
            countdown = setInterval(() => {
                timer--;
                timerEl.textContent = timer;
                if (timer <= 0) {
                    clearInterval(countdown);
                    startRace();
                }
            }, 1000);
        }

        function startRace() {
            gameState = 'racing';
            statusTextEl.textContent = 'Race in progress...';
            document.querySelector('.timer-box').style.visibility = 'hidden';
            racetrack.style.animationPlayState = 'running';
            if(raceSound) raceSound.play();
            let raceFinished = false;

            document.querySelectorAll('.horse').forEach((horse, i) => {
                const baseDuration = 8;
                const randomFactor = Math.random() * 2 - 1;
                const duration = baseDuration + randomFactor;
                horse.style.animation = `run ${duration}s linear forwards`;
                horse.addEventListener('animationend', () => {
                    if (!raceFinished) {
                        raceFinished = true;
                        declareWinner(i + 1);
                    }
                }, { once: true });
            });
        }
        
        function declareWinner(winnerHorseNumber) {
            gameState = 'finished';
            racetrack.style.animationPlayState = 'paused';
            if(raceSound) raceSound.pause();
            statusTextEl.textContent = `Horse #${winnerHorseNumber} wins!`;
            document.querySelector(`.bet-box[data-horse='${winnerHorseNumber}']`).classList.add('winner');

            if (bets[winnerHorseNumber]) {
                const winnings = bets[winnerHorseNumber] * PAYOUT_MULTIPLIER;
                database.ref('customers/' + loggedInUserKey + '/balance').set(firebase.database.ServerValue.increment(winnings));
                
                const winningsPopupEl = document.getElementById('winnings-popup');
                const winningsAmountEl = document.getElementById('winnings-amount');
                if(winningsPopupEl && winningsAmountEl) {
                   winningsAmountEl.textContent = `â‚¹ ${winnings.toFixed(2)}`;
                   winningsPopupEl.classList.add('show');
                   setTimeout(() => winningsPopupEl.classList.remove('show'), 3000);
                }
            }
            setTimeout(resetGame, 5000);
        }

        window.onload = () => {
            checkLoginStatus();
            initHorseGame();
        };
    </script>
</body>
</html>